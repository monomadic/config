#!/usr/bin/env bash

# mpv-clipper: Fast clip jumping mpv wrapper
# Save this as 'mpv-clipper' and make executable with: chmod +x mpv-clipper

# Create isolated config directory in ~/.config/mpv-clipper
CONFIG_DIR="$HOME/.config/mpv-clipper"
SCRIPT_DIR="$CONFIG_DIR/scripts"

# Create directories if they don't exist
mkdir -p "$SCRIPT_DIR"

# Write mpv.conf
cat > "$CONFIG_DIR/mpv.conf" << 'EOF'
# MPV Config for Fast Clip Jumping with 5-second Auto-advance

# Disable OSD completely
osd-level=0
osd-duration=0
no-osd-bar
no-osc

# Fast seeking optimizations
hr-seek=yes
hr-seek-framedrop=yes
hr-seek-demuxer-offset=0
index=default
demuxer-seekable-cache=yes
demuxer-max-bytes=50MiB
demuxer-max-back-bytes=25MiB

# Cache settings for smooth jumping
cache=yes
cache-secs=10
cache-pause=no
cache-pause-initial=no
cache-pause-wait=0

# Video output optimizations
vo=gpu
gpu-api=auto
hwdec=auto-safe
video-sync=audio
interpolation=no
framedrop=yes

# Audio settings for fast switching
audio-pitch-correction=no
audio-stream-silence=yes
gapless-audio=yes

# Reduce latency
audio-buffer=0.05
video-latency-hacks=yes

# Disable unnecessary features
no-sub
no-sub-auto
no-audio-display
no-term-osd-bar
no-input-default-bindings
no-window-dragging

# Keep player open after playback
keep-open=yes
idle=yes

# Disable screensaver
stop-screensaver=yes

# Fast startup
prefetch-playlist=yes
force-seekable=yes

# Script message for auto-advance
script-opts=autojump-interval=5
EOF

# Write autojump.lua script
cat > "$SCRIPT_DIR/autojump.lua" << 'EOF'
-- Auto-jump script for mpv

local options = {
    interval = 5,  -- Jump interval in seconds
    jump_size = 10, -- Size of jump in seconds
}

require 'mp.options'
read_options(options, "autojump")

local timer = nil
local enabled = false

function jump_forward()
    local current_pos = mp.get_property_number("time-pos", 0)
    local duration = mp.get_property_number("duration", 0)
    
    if duration > 0 then
        local new_pos = current_pos + options.jump_size
        
        if new_pos >= duration then
            -- Jump to next file in playlist
            mp.command("playlist-next")
        else
            -- Jump forward in current file
            mp.set_property_number("time-pos", new_pos)
        end
    end
end

function start_timer()
    if timer then
        timer:kill()
    end
    
    timer = mp.add_periodic_timer(options.interval, jump_forward)
    enabled = true
end

function stop_timer()
    if timer then
        timer:kill()
        timer = nil
    end
    enabled = false
end

function toggle_timer()
    if enabled then
        stop_timer()
    else
        start_timer()
    end
end

-- Auto-start on file load
mp.register_event("file-loaded", function()
    start_timer()
end)

-- Key bindings
mp.add_key_binding("ctrl+j", "toggle-autojump", toggle_timer)
mp.add_key_binding("ctrl+[", "decrease-interval", function()
    options.interval = math.max(1, options.interval - 1)
    if timer then start_timer() end
end)
mp.add_key_binding("ctrl+]", "increase-interval", function()
    options.interval = options.interval + 1
    if timer then start_timer() end
end)
EOF

# Write input.conf
cat > "$CONFIG_DIR/input.conf" << 'EOF'
# MPV Input Config for Fast Clip Navigation

# Quick seeking
RIGHT seek  5 exact
LEFT  seek -5 exact
UP    seek  30 exact
DOWN  seek -30 exact
Shift+RIGHT seek  1 exact
Shift+LEFT  seek -1 exact

# Frame stepping
. frame-step
, frame-back-step

# Speed controls
] multiply speed 1.1
[ multiply speed 0.9
\ set speed 1.0

# Quick jumps to percentage positions
1 seek 10 absolute-percent
2 seek 20 absolute-percent
3 seek 30 absolute-percent
4 seek 40 absolute-percent
5 seek 50 absolute-percent
6 seek 60 absolute-percent
7 seek 70 absolute-percent
8 seek 80 absolute-percent
9 seek 90 absolute-percent
0 seek 0 absolute-percent

# Playlist navigation
> playlist-next
< playlist-prev
ENTER playlist-next

# Quick mark/jump
m revert-seek mark
M revert-seek

# Toggle auto-jump (from lua script)
ctrl+j script-binding toggle-autojump
ctrl+[ script-binding decrease-interval
ctrl+] script-binding increase-interval

# Emergency stop auto-advance
SPACE cycle pause; script-binding toggle-autojump

# Quit
q quit
ESC quit
EOF

# Launch mpv with isolated config
exec mpv --config-dir="$CONFIG_DIR" "$@"
