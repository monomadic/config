#!/bin/zsh

# Check if URL is provided
if [ -z "$1" ]; then
  echo "Usage: $0 <faphouse-url>"
  exit 1
fi

# Extract the domain from the URL using sed
domain=$(echo "$1" | sed -E 's#https?://([^/]+).*#\1#')

# Ensure the site is faphouse.com, otherwise exit with an error
if [[ "$domain" != "faphouse.com" ]]; then
  echo "Error: This script should only be run on faphouse.com links. ($domain)"
  exit 1
fi

# Fetch the page content
html_content=$(curl -s "$1")

# Extract TITLE using perl
title=$(echo "$html_content" | perl -ne 'print "$1\n" if /<meta property="og:title" content="([^"]+)"/')

# Extract DESCRIPTION using perl
description=$(echo "$html_content" | perl -ne 'print "$1\n" if /<meta name="description" content="([^"]+)"/')

# Extract CREATOR using perl (adjusted for potential whitespace in the class attribute)
creator=$(echo "$html_content" | perl -ne 'print "$1\n" if /<a class="video-info-details__studio-link\s*" href="[^"]+">([^<]+)<\/a>/')

m3u8_url=$(echo "$html_content" | perl -ne 'print "$1\n" if /<link href="([^"]+\.m3u8)"/')

# Output the formatted string: [$creator] $title [FapHouse].mp4
if [ -n "$title" ] && [ -n "$creator" ]; then
  # Call yt-url with properly quoted variables
  yt-url "$m3u8_url" "\"[$creator] $title [FapHouse]\""
else
  echo "Error: Unable to extract required data."
  exit 1
fi
