#!/usr/bin/env zsh
set -euo pipefail

typeset -r GREEN=$'\e[32m'
typeset -r RED=$'\e[31m'
typeset -r NC=$'\e[0m'

error_exit() {
  print -P "${RED}[error] $1${NC}" >&2
  exit 1
}

check_command() {
  whence -p "$1" &>/dev/null || error_exit "$1 is not installed"
}

usage() {
  cat <<EOF
Usage: ${0:t} [options] <mode> <URL> [yt-dlp args]

Options:
  --mp4, --webm         Format preference
  --quiet, -q           Suppress "Executing:" message
  --dry-run, -n         Show command without executing
  --show-filename, -f   Show output filename without downloading
  --completion          Print zsh completion script to stdout and exit
  --help, -h            Show this help

Modes:
  music-video (m)   Download music video
  audio-only  (a)   Download audio only
  video-only  (v)   Download video without audio
  adult        (A)  Download adult content
  youtube      (y)  Download YouTube video
  best-quality (b)  Download best quality (video+audio)
EOF
}

print_completion() {
  local cmd=${0:t}
  cat <<EOF
#compdef ${cmd}

_arguments -s -S \\
  '--mp4[Prefer mp4-compatible streams/container when possible]' \\
  '--webm[Prefer webm-compatible streams/container when possible]' \\
  '(-q --quiet)'{-q,--quiet}'[Suppress Executing output]' \\
  '(-n --dry-run)'{-n,--dry-run}'[Print yt-dlp command and exit]' \\
  '(-f --show-filename)'{-f,--show-filename}'[Print filename without downloading]' \\
  '--completion[Print this zsh completion script and exit]' \\
  '(-h --help)'{-h,--help}'[Show help]' \\
  '1:mode:(music-video m audio-only a video-only v adult A youtube y best-quality b)' \\
  '2:URL:_urls' \\
  '*::yt-dlp args:_default'
EOF
}

# --- option parsing (allow --completion to bypass everything) ---
typeset FORMAT_PREF='' QUIET=0 DRY_RUN=0 SHOW_FILENAME=0

while [[ $# -gt 0 && $1 == -* ]]; do
  case $1 in
    --completion) print_completion; exit 0 ;;
    --help|-h) usage; exit 0 ;;
    --mp4)  FORMAT_PREF='mp4' ;;
    --webm) FORMAT_PREF='webm' ;;
    --quiet|-q) QUIET=1 ;;
    --dry-run|-n) DRY_RUN=1 ;;
    --show-filename|-f) SHOW_FILENAME=1 ;;
    --) shift; break ;;
    -*) error_exit "Unknown option: $1" ;;
  esac
  shift
done

(( $# < 2 )) && { usage; exit 1; }

check_command yt-dlp

typeset MODE=$1 URL=$2
shift 2
typeset -a EXTRA_ARGS=("$@")

# Detect passthrough commands
typeset PASSTHROUGH=0
for arg in "${EXTRA_ARGS[@]}"; do
  [[ $arg == --list-formats || $arg == --print || $arg == --dump-json ]] && { PASSTHROUGH=1; break; }
done

# Normalize shortcuts
case $MODE in
  m) MODE=music-video ;;
  a) MODE=audio-only ;;
  v) MODE=video-only ;;
  A|p) MODE=adult ;;
  y) MODE=youtube ;;
  b) MODE=best-quality ;;
esac

# Preference selectors
typeset VSEL='' ASEL='' PREF_CONTAINER=''
case ${FORMAT_PREF:-} in
  mp4)
    VSEL='[ext=mp4]'
    ASEL='[ext=m4a]'
    PREF_CONTAINER='mp4'
    ;;
  webm)
    VSEL='[ext=webm]'
    ASEL='[ext=webm]'
    PREF_CONTAINER='webm'
    ;;
esac

# Respect user override if they already passed merge/audio options
typeset HAS_MERGE=0 HAS_AUDIOFMT=0
for arg in "${EXTRA_ARGS[@]}"; do
  [[ $arg == --merge-output-format ]] && HAS_MERGE=1
  [[ $arg == --audio-format ]] && HAS_AUDIOFMT=1
done

typeset -a YTDL_BASE=(
  yt-dlp
  --cookies-from-browser brave
  --continue --progress
  --retries infinite --fragment-retries infinite --socket-timeout 15
)

typeset -a YTDL_CMD

if (( PASSTHROUGH )); then
  YTDL_CMD=("${YTDL_BASE[@]}" "${EXTRA_ARGS[@]}" "$URL")
else
  typeset OUTPUT_FMT=''
  typeset -a FMT_ARGS=()

  case $MODE in
    adult)
      OUTPUT_FMT='[%(uploader|Unknown)s] %(title)s [%(extractor)s].%(ext)s'
      FMT_ARGS+=(
        -f "bv*${VSEL}+ba${ASEL}/best"
        --embed-metadata --embed-info-json
        --match-filter "duration > 60"
      )
      (( HAS_MERGE == 0 && ${#PREF_CONTAINER} )) && FMT_ARGS+=(--merge-output-format "$PREF_CONTAINER")
      ;;
    music-video)
      OUTPUT_FMT='%(artist,channel,uploader|Unknown)s - %(title)s.%(ext)s'
      if [[ ${FORMAT_PREF:-} == mp4 ]]; then
        # Prefer H.264 when aiming for mp4 friendliness
        FMT_ARGS+=(-f "bestvideo${VSEL}[vcodec^=avc1]+bestaudio${ASEL}/best")
      else
        FMT_ARGS+=(-f "bestvideo${VSEL}+bestaudio${ASEL}/best")
      fi
      FMT_ARGS+=(--embed-metadata --embed-subs --embed-chapters)
      (( HAS_MERGE == 0 && ${#PREF_CONTAINER} )) && FMT_ARGS+=(--merge-output-format "$PREF_CONTAINER")
      ;;
    audio-only)
      OUTPUT_FMT='%(artist,channel,uploader|Unknown)s - %(title)s.%(ext)s'
      FMT_ARGS+=(-f "bestaudio${ASEL}/bestaudio")
      FMT_ARGS+=(--extract-audio --embed-metadata)
      if (( HAS_AUDIOFMT == 0 )); then
        [[ ${FORMAT_PREF:-} == webm ]] && FMT_ARGS+=(--audio-format opus) || FMT_ARGS+=(--audio-format m4a)
      fi
      ;;
    video-only)
      OUTPUT_FMT='%(artist,channel,uploader|Unknown)s - %(title)s.%(ext)s'
      FMT_ARGS+=(-f "bestvideo${VSEL}/bestvideo")
      FMT_ARGS+=(--embed-metadata)
      (( HAS_MERGE == 0 && ${#PREF_CONTAINER} )) && FMT_ARGS+=(--merge-output-format "$PREF_CONTAINER")
      ;;
    youtube)
      OUTPUT_FMT='[%(channel|Unknown)s] %(title)s [YouTube][%(id)s].%(ext)s'
      FMT_ARGS+=(-f "bv*${VSEL}+ba${ASEL}/best")
      FMT_ARGS+=(--embed-metadata --embed-subs --embed-chapters)
      (( HAS_MERGE == 0 && ${#PREF_CONTAINER} )) && FMT_ARGS+=(--merge-output-format "$PREF_CONTAINER")
      ;;
    best-quality)
      OUTPUT_FMT='%(uploader|Unknown)s - %(title)s.%(ext)s'
      FMT_ARGS+=(-f "bestvideo+ba/best" --merge-output-format mkv --embed-metadata)
      ;;
    *)
      error_exit "Unknown mode: $MODE"
      ;;
  esac

  YTDL_CMD=(
    "${YTDL_BASE[@]}"
    "${FMT_ARGS[@]}"
    --output "$OUTPUT_FMT"
    "${EXTRA_ARGS[@]}"
    "$URL"
  )

  if (( SHOW_FILENAME )); then
    YTDL_CMD+=(--print filename --skip-download)
  fi
fi

show_cmd() {
  # zsh-native safe quoting for arrays
  print -r -- ${(qq)YTDL_CMD}
}

if (( DRY_RUN )); then
  print -P "${GREEN}Command:${NC}"
  show_cmd
  exit 0
elif (( ! QUIET )); then
  print -P "${GREEN}Executing:${NC}"
  show_cmd
fi

"${YTDL_CMD[@]}"
