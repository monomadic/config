#!/usr/bin/env zsh
# vdjstems-pack-sidecar — build a VirtualDJ sidecar from pre-encoded .m4a stems
# Requires: ffmpeg, MP4Box (GPAC)
# Usage:
#   vdjstems-pack-sidecar \
#     --orig ORIGINAL.m4a \
#     --vocal VOCAL.m4a --hihat HIHAT.m4a --bass BASS.m4a --instr INSTR.m4a --kick KICK.m4a \
#     [-o OUTNAME] [--brands] [--flatten]
#
# Output (default): ORIGINAL.m4a.vdjstems
# Track order in output:
#   0 mixed track (the ORIGINAL, default) | 1 vocal | 2 hihat | 3 bass | 4 instruments | 5 kick

set -euo pipefail

die() { print -r -- "ERROR: $*" >&2; exit 1; }
have() { command -v "$1" >/dev/null 2>&1; }
have ffmpeg  || die "ffmpeg not found"
have MP4Box  || die "MP4Box not found (install GPAC)"

# ---- args ----
VOCAL=""; HIHAT=""; BASS=""; INSTR=""; KICK=""; ORIG=""; OUT=""; DO_BRANDS=0; DO_FLAT=0
while (( $# )); do
  case "$1" in
    --vocal)  VOCAL="${2:A}"; shift 2;;
    --hihat)  HIHAT="${2:A}"; shift 2;;
    --bass)   BASS="${2:A}";  shift 2;;
    --instr|--instruments) INSTR="${2:A}"; shift 2;;
    --kick)   KICK="${2:A}";  shift 2;;
    --orig)   ORIG="${2:A}";  shift 2;;
    -o|--out) OUT="${2}";     shift 2;;
    --brands) DO_BRANDS=1;    shift 1;;
    --flatten) DO_FLAT=1;     shift 1;;
    -h|--help)
      cat <<'EOF'
Usage:
  vdjstems-pack-sidecar --orig ORIGINAL.m4a \
    --vocal VOCAL.m4a --hihat HIHAT.m4a --bass BASS.m4a --instr INSTR.m4a --kick KICK.m4a \
    [-o OUTNAME] [--brands] [--flatten]

Notes:
- Expects all inputs already encoded in M4A (AAC/ALAC). Streams are copied losslessly (-c copy).
- Output defaults to ORIGINAL.m4a.vdjstems (VirtualDJ sidecar).
- Adds UDTA per-track names via MP4Box; per-stream titles are NOT set (ffprobe shows handler_name=SoundHandler).
- Use --brands to set mp42/mp41 brands; --flatten to produce flat storage.
EOF
      exit 0;;
    *) die "Unknown arg: $1";;
  esac
done

# ---- validations ----
[[ -n "$ORIG" ]] || die "Provide --orig ORIGINAL.m4a"
[[ -s "$ORIG" ]] || die "Missing: $ORIG"
for f in "$VOCAL" "$HIHAT" "$BASS" "$INSTR" "$KICK"; do
  [[ -n "$f" && -s "$f" ]] || die "Missing or empty stem (need --vocal/--hihat/--bass/--instr/--kick)"
done

# Output path
if [[ -z "$OUT" ]]; then
  OUT="${ORIG}.vdjstems"
else
  OUT="${OUT%.m4a}.m4a"  # normalize if they passed a bare name
fi

tmpdir="$(mktemp -d 2>/dev/null || mktemp -d -t vdjsidecar)"
trap 'rm -rf "$tmpdir"' EXIT
mux_tmp="$tmpdir/mux.m4a"

# ---- input order ----
# 0 kick | 1 instruments | 2 vocal | 3 bass | 4 hihat | 5 original (default/mixed)
typeset -a in_args
in_args=(-i "$KICK" -i "$INSTR" -i "$VOCAL" -i "$BASS" -i "$HIHAT" -i "$ORIG")

# Map to VDJ order: mixed(5) vocal(2) hihat(4) bass(3) instruments(1) kick(0)
typeset -a map_args
map_args=(-map 5:a -map 2:a -map 4:a -map 3:a -map 1:a -map 0:a)

# Dispositions: stream 0 default, others not
typeset -a disp_args
disp_args=(-disposition:a:0 default -disposition:a:1 0 -disposition:a:2 0 -disposition:a:3 0 -disposition:a:4 0 -disposition:a:5 0)

# ---- mux (stream copy) ----
# Also: strip container/global metadata & chapters; set handler_name=SoundHandler per stream.
ffmpeg -hide_banner -y \
  "${in_args[@]}" \
  "${map_args[@]}" \
  -c:a copy \
  -map_metadata -1 -map_chapters -1 \
  -metadata:s:a:0 handler_name="SoundHandler" \
  -metadata:s:a:1 handler_name="SoundHandler" \
  -metadata:s:a:2 handler_name="SoundHandler" \
  -metadata:s:a:3 handler_name="SoundHandler" \
  -metadata:s:a:4 handler_name="SoundHandler" \
  -metadata:s:a:5 handler_name="SoundHandler" \
  "${disp_args[@]}" \
  "$mux_tmp" >/dev/null 2>&1 || die "ffmpeg mux failed"

# ---- MP4Box tagging (UDTA names, optional brands/flatten) ----
# Track names by position: 1 mixed, 2 vocal, 3 hihat, 4 bass, 5 instruments, 6 kick
typeset -a mp4box_args
mp4box_args=(MP4Box
  -udta "1:type=name" -udta "1:type=name:str=mixed track"
  -udta "2:type=name" -udta "2:type=name:str=vocal"
  -udta "3:type=name" -udta "3:type=name:str=hihat"
  -udta "4:type=name" -udta "4:type=name:str=bass"
  -udta "5:type=name" -udta "5:type=name:str=instruments"
  -udta "6:type=name" -udta "6:type=name:str=kick"
)

# Optional iTunes-ish tags (customize or remove)
meta_txt="$tmpdir/itags.txt"
cat > "$meta_txt" <<EOF
tool=VirtualDJ sidecar
created=0
EOF
mp4box_args+=(-itags "$meta_txt")

# Optional brands / flatten
if (( DO_BRANDS )); then
  mp4box_args+=(-brand isom:512 -rb mp42 -ab mp41)
fi
if (( DO_FLAT )); then
  mp4box_args+=(-flat)
fi

mp4box_args+=(-out "$OUT" "$mux_tmp")
"${mp4box_args[@]}" >/dev/null 2>&1 || die "MP4Box failed"

print "OK → $OUT"

# ---- verify (human-readable) ----
print "\nffprobe (streams):"
ffprobe -v error -select_streams a \
  -show_entries stream=index,codec_name,sample_fmt,channels:stream_tags=title,handler_name \
  -of compact=p=0:nk=1 "$OUT" | sed 's/^/  /'
