#!/bin/zsh

# Video File Analyzer and Renamer
# Dependencies: ffprobe (part of ffmpeg)

set -o errexit -o pipefail

DRY_RUN=false
USE_COLOR=false

# NerdFonts icons
ICON_VIDEO="󰎈"
ICON_OK=""
ICON_WARN=""

# Color handling (disabled by default)
RESET=""; GREEN=""; YELLOW=""; CYAN=""

enable_color() {
  RESET=$'\e[0m'
  GREEN=$'\e[32m'
  YELLOW=$'\e[33m'
  CYAN=$'\e[36m'
  USE_COLOR=true
}

# Parse options
while [[ $# -gt 0 ]]; do
  case "$1" in
    --dry-run) DRY_RUN=true; shift ;;
    --color) enable_color; shift ;;
    -h|--help)
      print -r -- "Usage: $0 [OPTIONS] video_file..."
      print -r -- "Options:"
      print -r -- "  --dry-run    Show what would be done without renaming"
      print -r -- "  --color      Enable ANSI colors in output"
      print -r -- "  -h, --help   Show this message"
      exit 0
      ;;
    -*)
      print -r -- "${YELLOW}${ICON_WARN} Unknown option: $1${RESET}"
      exit 1
      ;;
    *) break ;;
  esac
done

# Ensure ffprobe exists
if ! command -v ffprobe &>/dev/null; then
  print -r -- "${YELLOW}${ICON_WARN} ffprobe is required but not installed.${RESET}"
  exit 1
fi

# Strip ALL {...} blocks and known #tags
clean_name() {
  local name="$1"
  # remove every {...} block (non-nested)
  name="$(printf '%s' "$name" | sed -E 's/\{[^}]*\}//g')"
  # remove specific #tags
  local tags=(1080p 1080 720p 4k 60fps 30fps 25fps)
  for t in $tags; do
    name="${name//\#$t/}"
  done
  # remove trailing " s01"
  name="$(printf '%s' "$name" | sed -E 's/[[:space:]]s01$//I')"
  # collapse & trim spaces
  name="${name//  / }"; name="${name//  / }"   # twice to be safe
  name="${name## }"; name="${name%% }"
  print -r -- "$name"
}

# Extract a 5-char rating like ★★★☆☆ from anywhere in the name
# Prints: "<name_without_rating>\n
