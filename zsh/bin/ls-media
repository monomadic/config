#!/usr/bin/env zsh

# Display usage information
usage() {
  echo "Usage: $0 [--color] [--match PATTERN]"
  echo "List media files in directories specified by ls-media-paths"
  echo "Options:"
  echo "  --color          Enable colored output"
  echo "  --match PATTERN  Only list files matching the given pattern"
}

# Parse arguments
color_option="--color=never"
match_pattern=""

while [[ $# -gt 0 ]]; do
  case $1 in
  --color)
    color_option="--color=always"
    shift
    ;;
  --match)
    if [[ -z "$2" ]]; then
      echo "Error: --match requires a PATTERN argument"
      usage
      exit 1
    fi
    match_pattern="$2"
    shift 2
    ;;
  *)
    echo "Error: Unknown option $1"
    usage
    exit 1
    ;;
  esac
done

# List media files
while IFS= read -r media_path; do
  if [[ -d "$media_path" ]]; then
    if [[ -n "$match_pattern" ]]; then
      fd -i -e mp4 -e avi -e mkv -e mov -e wmv -e flv -e webm $color_option "$match_pattern" "$media_path"
    else
      fd -i -e mp4 -e avi -e mkv -e mov -e wmv -e flv -e webm $color_option . "$media_path"
    fi
  fi
done < <(ls-media-paths)
