#!/bin/zsh

# Colors and NerdFont icons (JetBrains Mono Nerd Font)
GREEN="\033[0;32m"
RED="\033[0;31m"
YELLOW="\033[0;33m"
RESET="\033[0m"

CHECK=""               # nf-md-check_circle_outline
CROSS=""               # nf-md-close_circle_outline
ROUTER_ICON=""         # nf-fa-wifi
INTERNET_ICON=""       # nf-fa-globe
DNS_ICON=""            # nf-md-dns
CAPTIVE_PORTAL_ICON="" # nf-mdi-lock_alert

# Automatically detect the router IP (gateway)
GATEWAY_IP=$(route -n get default | grep 'gateway' | awk '{print $2}')
TEST_SITE="8.8.8.8"                                                  # External IP for Internet connectivity check
DNS_SERVER="1.1.1.1"                                                 # Public DNS server (Cloudflare)
CAPTIVE_TEST_URL="http://connectivitycheck.gstatic.com/generate_204" # Captive portal check URL

function print_status() {
  if [[ $1 -eq 0 ]]; then
    printf "%-40s %b\n" "$2" "${GREEN}${CHECK}${RESET}"
  else
    printf "%-40s %b\n" "$2" "${RED}${CROSS}${RESET}"
  fi
}

echo -e "\n${ROUTER_ICON} ${YELLOW}Wi-Fi Diagnostic Tool${RESET}\n"

# 1. Check Wi-Fi status
WIFI_STATUS=$(networksetup -getairportnetwork en0)
if [[ "$WIFI_STATUS" =~ "You are not associated" ]]; then
  print_status 1 "Wi-Fi Connection"
  echo -e "\n${RED}Please connect to a Wi-Fi network and try again.${RESET}\n"
  exit 1
else
  print_status 0 "Wi-Fi Connection"
  echo -e "  Network: ${YELLOW}$(echo $WIFI_STATUS | cut -d ':' -f2 | xargs)${RESET}\n"
fi

# 2. Ping the router (Gateway IP)
echo -e "Detected Gateway IP: ${YELLOW}${GATEWAY_IP}${RESET}\n"
print_status $(
  ping -c 1 $GATEWAY_IP >/dev/null 2>&1
  echo $?
) "Router (Gateway) Reachability"

# 3. Ping a known internet IP
print_status $(
  ping -c 1 $TEST_SITE >/dev/null 2>&1
  echo $?
) "Internet Reachability (Ping to ${TEST_SITE})"

# 4. DNS lookup
print_status $(
  nslookup google.com $DNS_SERVER >/dev/null 2>&1
  echo $?
) "DNS Resolution (Server: ${DNS_SERVER})"

# 5. Check for captive portal
print_status $(
  curl -s -o /dev/null -w "%{http_code}" $CAPTIVE_TEST_URL | grep -q 204
  echo $?
) "Captive Portal Check (${CAPTIVE_TEST_URL})"

echo -e "\n${INTERNET_ICON} ${YELLOW}Network diagnostics complete.${RESET}\n"
