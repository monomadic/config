#!/usr/bin/env zsh
set -euo pipefail

url="${1:-}"
[[ -z "$url" ]] && { print -u2 "usage: ${0:t} <url> [output_dir]"; exit 1; }

output_path="${2:-$PWD}"
echo "Downloading to: $output_path"

output_template=""
output_template+="%(cast,uploader|)l"
output_template+="%(cast& - |)s"
output_template+="[%(channel,uploader|Unknown)s] "
output_template+="%(title)s "
output_template+="(%(extractor)s)"
output_template+="%(tags.0& #{}|)s%(tags.1& #{}|)s%(tags.2& #{}|)s%(tags.3& #{}|)s%(tags.4& #{}|)s"
output_template+=".%(ext)s"

yt-dlp \
  --paths "$output_path" \
  --output "$output_template" \
  --output-na-placeholder "" \
  --replace-in-metadata "tags" "[ _]+" "-" \
  --progress --console-title \
  --trim-filenames 200 \
  "$url"
