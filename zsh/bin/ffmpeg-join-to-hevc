#!/bin/zsh

# Combine multiple videos into one HEVC-encoded file
# Usage: ./ffmpeg-join-to-hevc output.mp4 input1.mp4 input2.mp4 ...

if [[ $# -lt 2 ]]; then
    echo "Usage: $0 output.mp4 input1.mp4 [input2.mp4 ...]"
    exit 1
fi

output="$1"
shift
inputs=("$@")

if [[ -e "$output" ]]; then
    echo "Error: Output file '$output' already exists"
    exit 1
fi

# Create temporary concat file
tmpfile=$(mktemp)
trap "rm -f $tmpfile" EXIT

for input in "${inputs[@]}"; do
    if [[ ! -f "$input" ]]; then
        echo "Error: Input file '$input' not found"
        exit 1
    fi
    # Escape single quotes and add to concat file
    echo "file '${input//\'/\'\\\'\'}'" >> "$tmpfile"
done

echo "Combining ${#inputs[@]} videos..."
echo "Output: $output"
echo "Settings: HEVC, 2160p60, ~40Mbps"

ffmpeg -f concat -safe 0 -i "$tmpfile" \
    -c:v hevc_videotoolbox \
    -b:v 40M \
    -vf "scale=3840:2160:flags=lanczos,fps=60" \
    -tag:v hvc1 \
    -c:a aac \
    -b:a 256k \
    -movflags +faststart \
    -y "$output"

echo "Done: $output"
