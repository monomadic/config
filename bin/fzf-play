#!/bin/zsh

fzf \
  --ansi \
  --multi \
  --exact \
  -i \
  --preview 'ffmpeg -loglevel error -ss 00:00:01 -i {} -vf "scale=80:-1,select=eq(n\,0)" -vframes 1 -f image2 - 2>/dev/null | chafa -c full --format=symbols --size=80x40 2>/dev/null' \
  --preview-window=hidden \
  --bind 'enter:select-all+execute-silent(mpv --loop-file=1 --shuffle --macos-fs-animation-duration=0 --no-native-fs --fs {+})+deselect-all' \
  --bind 'alt-enter:select-all+execute-silent(mpv --loop-file=1 --length=10 --shuffle --macos-fs-animation-duration=0 --no-native-fs --fs {+})+deselect-all' \
  --bind 'alt-L:select-all+execute-silent(mpv --loop-file=1 --length=2 --shuffle --macos-fs-animation-duration=0 --no-native-fs --fs {+})+deselect-all' \
  --bind 'alt-A:select-all+execute(airflow-open {})' \
  --bind 'alt-a:select-all,alt-d:deselect-all,ctrl-/:toggle-preview' \
  --bind 'alt-e:select-all+execute(elmedia-open {})' \
  --bind 'alt-o:execute-silent(kitty @ launch --cwd $PWD/$(dirname {}))' \
  --bind 'alt-i:select-all+execute(iina-open {})' \
  --bind 'alt-c:execute(kitty @ launch --cwd $(dirname {}) lf)' \
  --bind 'alt-m:select-all+execute-silent(mpv --macos-fs-animation-duration=0 {+})' \
  --bind 'alt-P:select-all+execute-silent(printf "%s\n" {+} > playlist.m3u)+abort' \
  --bind 'alt-p:toggle-preview' \
  --bind 'alt-r:execute(open --reveal {})' \
  --bind 'alt-s:select-all+accept' \
  --bind 'alt-t:execute-silent(kitty @ launch --cwd $(dirname {}))' \
  --bind 'alt-v:execute-silent(vlc {})' \
  --header 'enter:play-all | alt-o:play | alt-enter:loop-mode | alt-r:reveal-in-finder | alt-t:new-tab | alt-i:iina | alt-e:elmedia | alt-A:airflow | alt-a:select-all | alt-d:deselect-all | alt-l:lf | alt-s: stdout | alt-p:playlist' \
  --color header:italic:47 \
  --query "$*" # $* treat all arguments as a single string
